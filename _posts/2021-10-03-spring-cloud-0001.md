---
title: Spring cloud 的注册中心
key: 2019-10-03
tags: spring spring-cloud eureka zookeeper 
---

- 服务发现
- spring-cloud-eureka

<!--more-->

## 服务发现

### 服务发现技术选型

Jason Wilder 在 2014 年2 月的时候写了一片博客 [Open-Source Service Discovery](http://jasonwilder.com/blog/2014/02/04/service-discovery-in-the-cloud/), 总结了当时市面上的几类服务发现组建.

| 名称 | 类型 | AP/CP | 语言 | 依赖 | 集成 | 一致性算法|
| ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| Zookeeper | General | CP | java | JVM | Client binding | Paxos |
| Doozer |  General | CP | Go | | Client Binding | Paxos |
| Consul | General | CP | Go |  | HTTP/DNS Library | Raft |
| Etcd | General | CP or Mixed(1) | Go | | Client Binding /HTTP | Raft |
| SmartStack | Dedicted | AP | Ruby | haproxy/Zookeeper | Sidekick (nerve/synapse) } }
| Eureka | Dedicated | AP | Java | JVM | Java client | |
| NSQ (lookupd) | Dedicated | AP | Go | | Client Bindign | |
| Serf | Dedicted | AP | Go | | Local CLI | |
| Spoify(dns) | Dedicated | AP | N/A | Bind | DNS Lisbrary | |
| skyDNS | Dedicated | Mixed(2) | Go | | HTTP/DNS library | |
| Nacos | ? | ? | Java | JVM | Java client | |

从上面的表中可以看到, 服务发现有很多组建可以选择.

## spring-cloud-eureka

Netflix Eureka 是 Netflix 开源的一款基于 REST 的服务发现组建, 包括 Eureka Server 和 Eureka Client. Sring Cloud Netflix Eureka 是 Pivotal 公司为了将 Netflix Eureka 整合于 Spring Cloud 生态中提高的版本, 目前 spring cloud 中使用的 Eureka 是 1.x 版本.

Eureka 提供的服务发现可以为负载均衡,  failover 等提供支持.

Eureka 最初是针对 AWS 不提供中间服务层的负载均衡的限制而涉及开发的. AWS Elastic Load Balancer 用来对客户端或终端设备进行负载均衡, 而 Eureka 则用来对中间层的服务做服务妨碍安, 配合其他组建提供负载均衡的能力.

设计 Eureka 主要是因为, 如果直接使用 AWS 的 ELB 对内部进行负载均衡, 会将内部应用暴露到外网, 存在安全性问题; 还有就是 AWS 的 ELB 是传统的基于代理的负载均衡解决方案, 无法直接就服务元数据信息定制负载均衡算法, 设计的 Eureka 一方面给内部服务做服务发现, 另一方面可以结合 ribbon 组建提供各种个性化的负载均衡算法.

而 AWS Route 53 是一款命名服务, 可以给中间层的服务提供服务妨碍那功能, 但是他是基于 DNS 的服务, 传统的基于 DNS 的负载均衡技术存在更新掩饰问题, 另外主要是无法对服务健康状态进行检查.

### Eureka 和 Consul 的区别

Eureka Server 段采用的是 P2P 的复制模式, 但是它不保证复制操作一定鞥成功, 因此它提供的是一个最终一致性的服务实例试图; Client 端在 Server 端的组册信息有一个带期限的租约, 一旦 Server 端在指定期间没有收到 Client 端发送的心跳, 则 Server 端会认为 Client 端注册的服务是不健康的, 定时任务会将其哦难过注册表中删除.

Consul 采用 Raft 算法, 可以体统强一致性的保证, Consul 的 agent 相当于 Netflix Ribbon + Netflix Eureka Client , 而且对应用来说相对透明,同时相对与 Eureka 这种集中式的心跳检测机制, Consul 的 agent 可以篡预到基于 gossip 协议的健康检查, 分散了 Server 端的心跳检测压力. 此外, Consul 为多数据中心提供了开箱即用的原生支持等.

那么居于什么考虑因素可以选择 Eureka 呢? 主要原因有如下几点:

- 选择 AP 而不是 CP
- 团队都是使用 Java 语言开发的.(技术上比较统一, 出现问题也好排查修复, 对组建的掌控力比较强, 防办扩展维护)
- Eureka 是 Netflix 开源套件的一部分, 和 zuul / ribbon 等整合比较好.



EOF
